---
title: "Estimating a Bayes factor for a difference in means"
description: | 
  Using Savage-Dickey and bridge sampling
date: 05-29-2021
categories:
  - multilevel models
  - Bayes factor
author:
  - first_name: "Andrew"
    last_name: "Ellis"
    url: https://github.com/awellis
    affiliation: Cognitive psychology, perception & methods, Univerity of Bern 
    affiliation_url: https://www.kog.psy.unibe.ch
    orcid_id: 0000-0002-2788-936X

citation_url: https://awellis.github.io/learnmultilevelmodels/bayes-factor-group-difference.html
bibliography: ../../bibliography.bib
output: 
    distill::distill_article:
      toc: true
      toc_float: true
      toc_depth: 2
      code_folding: false
      css: ../../css/style.css
---





# Bayes factor for difference in means

We are going to look at data from a study in which children with ADHD were compared to a control group in terms of their working memory capacity


```{r}
library(tidyverse)
nback <- read_csv("https://raw.githubusercontent.com/kogpsy/neuroscicomplab/main/data/adhd-nback.csv")
```

Die grouping variable `group` should be converted to a factor.


```{r}
nback <- nback %>% 
  mutate(group = as_factor(group),
         group = fct_relevel(group, "control"))
```

A directed Welch test result in a p-value of approx. 0.07. We cannot reject the null hypothesis.

```{r}
t.test(rt ~ group,
       data = nback,
       alternative = "less")
```

We now want to perform a Bayesian model comparison using a Bayes factor.


:::exercise
**Exercise 1**
Estimate an intercept and a group difference. Use a `normal(0, 1)` for the group difference.
:::

```{r echo=FALSE, include=FALSE}
library(brms)

get_prior(rt ~ 1 + group,
          data = nback)
priors <- prior(normal(0, 1), class = b)
```

```{r echo=FALSE, include=FALSE}
m1 <- brm(rt ~ group,
          prior = priors,
          data = nback,
          file = "models/exc4-m1")
```


```{r}
summary(m1)
```

The population level effects `Intercept` and `groudadhd` represent the expected mean of the control group, and the expected difference between groups. The parameter has a mean of  $0.16$ a  $95%$ credible interval of  $[-0.04, 0.35]$.



In der Lösung von Übung 2 habe ich gezeigt, wie Sie mit der `hypothesis()` Funktion die Wahrscheinlichkeit erhalten, dass der Unterschied zwischen den Gruppen positiv ist.

:::exercise
**Exercise 2**

a) Use the `hypothesis()` function to obtain the probability that the parameter is $>0$.

b) Save the output of `hypothesis()` and plot it (using `plot()`.
:::


```{r}
h1 <- m1 %>% 
  hypothesis("groupadhd > 0")

h1
```


Wir untersuchen hier, welcher Anteil der Posterior Verteilung des Gruppenunterschieds `groupadhd` positiv ist. Das Evidence Ratio `Evid.Ratio` gibt den Anteil der Fläche unter der Kurve, welcher positiv ist, geteilt durch den negativen Anteil. Wir erhalten ein Evidence Ratio von $17.18$, was bedeutet, dass der positive Anteil der Fläche $17.18$ mal grösser ist als der negative Anteil.

Folglich ist es $17.18$ mal wahrscheinlicher, dass der Parameter positiv ist, als dass er negativ ist. Mit dieser Information können wir die Wahrscheinlichkeit, dass der Parameter positiv ist, berechnen. Wir müssen lediglich die Wahrscheinlichkeit $p_+$ finden, für die gilt: $\frac{p_+}{1-p_+} = 17.18$. Nach Umformen erhalten wir $p_+ = 17.18/(1 + 17.18) = 0.945$. DIes ist genau die Wahrscheinlichkeit, welhe wir unter `Post.Prob` erhalten.

```{r}
p_pos <- 17.18 / (1 + 17.18)
p_pos
```



```{r}
plot(h1)
```

:::exercise
**Aufgabe 3**

Schätzen Sie das Modell von Aufgabe 1 nochmals, aber diesmal mit dem zusätzlichen Argument `sample_prior = TRUE`. Speichern Sie dies als `m2`.
:::


```{r}
m2 <- brm(rt ~ group,
          prior = priors,
          sample_prior = TRUE,
          data = nback1,
          file = "models/exc4-m2")
```


Dies führt dazu, dass Sie neben den Samples aus den Posterior Verteilung auch Samples aus den Prior Verteilungen erhalten. Diese können Sie für den Unterschied zwischen den Gruppen so grafisch darstellen.

```{r}
m2 %>% 
  mcmc_plot(c("b_groupadhd", "prior_b"))
```
Wir sehen in dieser Grafik die Prior und die Posterior Verteilungen von `b_groupadhd`, also das, was wir anfangs geglaubt haben, und das, was wir glauben, nachdem wir die Daten berücksichtigt haben.


:::exercise
**Aufgabe 4**

Testen Sie nun die Nullhypothese, dass der Gruppenunterschied Null sein sollte, mit der `hypothesis()` Funktion (Savage-Dickey Density Ratio). 

- Speichern Sie den Ouput als `h2`.
- Schauen Sie sich den Output an (mit `print(h2)` oder einfach `h2`.)
- Evidence Ratio `Evid.Ratio` ist der Bayes Factor $BF_{01}$. Der Output der `hypothesis()` Funktion ist übrigens eine Liste; das `Evid.Ratio` kann mit `h2$hypothesis$Evid.Ratio` extrahiert werden. Speichern Sie es als `BF01`.
- Erklären Sie in Worten, was der $BF_{01}$ bedeutet. Wofür haben Sie Evidenz gefunden?
- Zeigen Sie auch den Bayes Factor $BF_{10}$ (Tipp: dies ist ganz einfach, wenn Sie $BF_{01}$ haben). Was sagt uns $BF_{10}$?
:::


```{r}
h2 <- m2 %>% 
  hypothesis("groupadhd = 0")
h2
```

```{r}
BF01 <- h2$hypothesis$Evid.Ratio
BF01
```
Der Bayes Factor $BF_{01}$ gibt an, um wieviel wahrscheinlicher die Daten unter der Nullhypothese als unter der Alternativhypothese sind. Die Alternativhypothese entspricht unserem Prior, der besagt, dass der Unterschied zwischen den Gruppen mit 95% Sicherheit zwischen -2 und 2 liegt. Dieser Prior ist scheinbar nicht besonder gut, denn unter der Nullhypothese, welche behauptet, dass der Parameter genau 0 ist, sind die Daten ca. 2.6 mal wahrscheinlicher als unter der Alternativhypothese. Wir erhalten also hier Evidenz für die Nullhypothese, obwohl wir uns fas 95% sicher, dass der Parameter, wenn er geschätzt wird, positiv ist.

Der Bayes Factor für die Alternativhypothse beträgt $0.38$.


```{r}
BF10 <- 1/BF01
BF10
```



:::exercise
**Aufgabe 5**

Stellen Sie den Ouput von `hypothesis()` mit `plot()` grafisch dar.
:::


```{r echo=FALSE, include=FALSE}
plot(h2)
```
Wir sehen, dass der WErt 0 unter dem Posterior eine höhere Wahrscheinlichkeit als unter dem Prior hat.

:::puzzle
Optionale Aufgabe: Wie erhalten Sie einen grösseren Bayes Factor für die Alternativhypothese $BF_{10}$?
:::

Wir können versuchen, einen sinnvolleren Prior für unsere Alternativhypothese zu defnieren. Als erstes könnten wir, wenn Informationen aus vorherigen Studien haben, erwarten dass der Effekt klein sein. Dies berücksichtigen wir mit einer kleineren Standardabweichung von $0.1$. Ausserdem erwarten wir, dass der Effekt positiv wird. Dies können wir ausdrücken, in dem wir eine Untergrenze von 0 für die Prior Verteilung setzen (lower bound). Wenn wir beides komnbinieren, erhalten wir folgenden Prior: `prior(normal(0, 0.1), lb = 0)`. Dies enstpricht einer halben Normalverteilung, mit einer Standardabweichung von $0.1$. 



```{r}
m3 <- brm(rt ~ group,
          prior = prior(normal(0, 0.1), lb = 0),
          sample_prior = TRUE,
          data = nback1,
          file = "models/exc4-m3")
```

Wir können wieder Prior und Posterior grafisch darstellen. Der Prior erlaubt jetzt nur noch positive Werte.

```{r}
m3 %>% 
  mcmc_plot(c("b_groupadhd", "prior_b"))
```

```{r}
h3 <- m3 %>% 
  hypothesis("groupadhd = 0")
h3
```


Wir erhalten nun einen Bayes Factor von $0.42 für die Nullhypothese. Dies bedeutet, dass nun die Daten unter der Alternativhypothese wahrscheinlicher sind. 



```{r}
BF01alt <- h3$hypothesis$Evid.Ratio
BF01alt
```

Dies ist einfacher als $BF_{10}$ auszudrücken:

```{r}
BF10alt <- 1/BF01alt
BF10alt
```
Wir erhalten nun also einen Bayes Factor von $2.36$ für die Alternativhypothese. 

Dies illustriert, dass ein Bayes Factor ausdrückt, wie gut ein e Prior Verteilung die Daten vorhersagen kann. Hypothesen entpsrechen im Bayesianischen Kontext Prior Verteilungen, und folglich müssen wir mit unseren Priors genau unsere Hypothesen ausdrücken können. Der zweite Bayes Factor $BF_{10} = 2.36$ entspricht also unserer Erwartung, dass der Gruppenunterschied klein aber positiv ist.
